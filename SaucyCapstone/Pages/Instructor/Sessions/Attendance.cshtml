@page
@using Data
@model SaucyCapstone.Pages.Instructor.Sessions.AttendanceModel
@{
	var BeginningRange = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);
	var EndingRange = BeginningRange.AddDays(28).AddSeconds(-1);
	var FutureDates = @Model.SessionDates.Select(d => d.Date).Where(d => d >= BeginningRange.AddDays(28 * ((double)Model.offset + 1.00)) && d <= EndingRange.AddDays(28 * ((double)Model.offset + 1.00))).ToList();
	var PastDates = @Model.SessionDates.Select(d => d.Date).Where(d => d >= BeginningRange.AddDays(28 * ((double)Model.offset - 1.00)) && d <= EndingRange.AddDays(28 * ((double)Model.offset - 1.00))).ToList();
	Attendance? attendance;
	Guid ButtonGuid;
	var index = 0;
}
<div class="container">
	<div class="row pt-4">
		<div class="col-6">
			<h2 class="text-primary">Session For @(Model.Session.Course.Subject.SubjectName + " " + Model.Session.Course.CourseLevel + " " + Model.Session.DayofWeek)</h2>
			<h2 class="text-primary">@(Model.Session.StartTime.ToShortTimeString()+ " - " + Model.Session.EndTime.ToShortTimeString())</h2>
		</div>
	</div>

	<a id="Previous" class="btn btn-info mx-2" asp-page="Attendance" asp-route-id="@Model.Session.SessionId" asp-route-offset="@(Model.offset - 1)">Previous Page</a>
	<a id="Next" class="btn btn-info mx-2" asp-page="Attendance" asp-route-id="@Model.Session.SessionId" asp-route-offset="@(Model.offset + 1)">Next Page</a>
	
	<br />
	<br />	
	<form method="post">
	<table id="dataTable" class="table table-bordered table-striped" style="width:100%">
		<thead>
			<tr>
				<th>
					Student					
				</th>
					@foreach (var SessionDate in Model.SessionDates.Select(d => d.Date).Where(d => d >= @BeginningRange.AddDays(28 * (double)Model.offset) && d <= @EndingRange.AddDays(28 * (double)Model.offset)).ToList())
					{
						<th class="col text-center" width="20%">
							@SessionDate.ToLongDateString() 
							<br>
							<button type="button" class="btn btn-primary mt-2 mb-2">Mark All Present</button>
							<br>
							<button type="button" class="btn btn-danger mb-2">Unmark All</button>
						</th>
					}
			</tr>
		</thead>
		<tbody>
			@if (@Model.Enrollments != null)
			{			
				@foreach (var Enrollment in Model.Enrollments)
				{
					<tr>
						<td width="20%" >					
							<a class="m-2" asp-page="../Students/Add/addNotes" asp-route-studentId="@Enrollment.Student.StudentId"><img src="@Enrollment.Student.ImageUrl" width="30%" style="border-radius:5px; border:1px solid #bbb9b9" /></a>
							@(Enrollment.Student.FirstName + " " + Enrollment.Student.LastName)						
						</td>
						
						@foreach (var SessionDate in Model.SessionDates.Where(d => d.Date >= @BeginningRange.AddDays(28 * (double)Model.offset) && d.Date <= @EndingRange.AddDays(28 * (double)Model.offset)).ToList())
						{
							ButtonGuid = Guid.NewGuid();
							attendance = @SessionDate.Attendances?.Where(d => d.StudentId == Enrollment?.StudentId).FirstOrDefault();
							<td class="col text-center">
								<input asp-for="@Model.SessionId" value="@Model.SessionId" hidden>
								<input asp-for="@Model.offset" value="@Model.offset" hidden>
								<input name="Attendances[@index].AttendanceId" value="@(attendance?.AttendanceId ?? 0)" hidden>
								<input id="@(ButtonGuid + "input")" name="Attendances[@index].Status" value="@((int?)attendance?.Status ?? 2)" class="btn btn-outline-success" hidden>
								<input name="Attendances[@index].StudentId" value="@Enrollment.StudentId" hidden>
								<input name="Attendances[@index].SessionDateId" value="@SessionDate.SessionDateId" hidden>
								<button id="@ButtonGuid" type="button" class="@((int?)attendance?.Status == 0 ? "btn btn-success": "btn btn-danger")" onclick="changeColors(this.id)" style="padding: 30px"></button>
							</td>
							index++;
						}
					</tr>
				}				
			}
		</tbody>
	</table>
		<button type="submit" class="btn btn-success">Save</button>
		<a class="btn btn-primary" asp-page="Index">Go Back</a>
	</form>
</div>

@section Scripts{

	<script>
		$(document).ready(function() {
            $('#dataTable').dataTable({			
				"ordering": false
			});
            if (@PastDates.Count == 0) {
				$( "#Previous" ).removeAttr( 'href' );
			} 
			if (@FutureDates.Count == 0) {
				$( "#Next" ).removeAttr( 'href' );
			} 
		});	 
		function changeColors(val) {
            const button = document.getElementById(val);
            const input = document.getElementById(val + "input");

			if (button.className == "btn btn-danger") {
                button.className = "btn btn-success";
                input.value = "0";
			}
			else if (button.className == "btn btn-success") {
                button.className = "btn btn-danger";
                input.value = "2";
			}
		}
	</script>
}
